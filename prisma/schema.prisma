generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "windows", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id            Int            @id @default(autoincrement())
  first_name    String         @db.VarChar(255)
  last_name     String         @db.VarChar(255)
  email         String         @unique @db.VarChar(255)
  password      String         @db.VarChar(255)
  adminType     AdminType      @map("admin_type")
  organization  String?        @db.VarChar(255)
  bio           String?
  profile_image String?
  contactPhone  String?        @map("contact_phone") @db.VarChar(20)
  website       String?
  isVerified    Boolean        @default(false) @map("is_verified")
  isActive      Boolean        @default(true) @map("is_active")
  lastLogin     DateTime?      @map("last_login") @db.Timestamptz(6)
  createdBy     Int?           @map("created_by")
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  creator       Admin?         @relation("AdminCreator", fields: [createdBy], references: [id])
  createdAdmins Admin[]        @relation("AdminCreator")
  programs      Program[]      @relation("ProgramAuthor")
  questions     QuestionPool[] @relation("QuestionAuthor")

  @@map("admins")
}

model Learner {
  id                 Int               @id @default(autoincrement())
  first_name         String            @db.VarChar(255)
  last_name          String            @db.VarChar(255)
  gender             String?           @db.VarChar(50)
  dob                DateTime?         @map("date_of_birth") @db.Date
  email              String            @unique @db.VarChar(255)
  phone              Bytes?
  communicationEmail Bytes?            @map("communication_email")
  password           String?
  profile_image      String?
  organisation       String?           @db.VarChar(255)
  designation        String?           @db.VarChar(255)
  department         String?           @db.VarChar(255)
  location           String?           @db.VarChar(255)
  hierarchy_level    String?           @map("hierarchy_level") @db.VarChar(255)
  totalPoints        Int               @default(0) @map("total_points")
  isActive           Boolean           @default(true) @map("is_active")
  isDeleted          Boolean           @default(false) @map("is_deleted")
  deletedAt          DateTime?         @map("deleted_at") @db.Timestamptz(6)
  isVerified         Boolean           @default(false) @map("is_verified")
  lastLogin          DateTime?         @map("last_login") @db.Timestamptz(6)
  createdBy          Int?              @map("created_by")
  createdAt          DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  uniqueHash         String?           @map("unique_hash")
  status             Int?
  extraConfig        String?           @map("extra_config")
  metaData           String?           @map("meta_data")
  role               String            @db.VarChar(20)
  enrollments        Enrollment[]      @relation("LearnerEnrollments")
  leaderboards       Leaderboard[]
  creator            Learner?          @relation("LearnerCreator", fields: [createdBy], references: [id])
  createdLearners    Learner[]         @relation("LearnerCreator")
  measureProgress    MeasureProgress[]
  quizAttempts       QuizAttempt[]     @relation("LearnerAttempts")
  resourceViews      ResourceView[]

  @@map("learners")
}

model Program {
  id               Int               @id @default(autoincrement())
  authorId         Int               @map("author_id")
  title            String            @db.VarChar(255)
  description      String
  category         String            @db.VarChar(100)
  instructor       String            @db.VarChar(255)
  instructorAvatar String?           @map("instructor_avatar")
  image            String?
  rating           Float?            @default(0) @map("rating")
  level            String?           @db.VarChar(50)
  price            Decimal           @db.Decimal(10, 2)
  type             ProgramType?
  totalTimeLimit   Int?              @map("total_time_limit")
  status           Int?              @db.SmallInt
  uniqueHash       String?           @map("unique_hash") @db.VarChar(255)
  startDate        DateTime?         @map("start_date") @db.Date
  endDate          DateTime?         @map("end_date") @db.Date
  surveyStartDate  DateTime?         @map("survey_start_date") @db.Date
  surveyEndDate    DateTime?         @map("survey_end_date") @db.Date
  passingScore     Int?              @map("passing_score")
  studySettings    Json?             @map("study_settings")
  clientId         Int?              @map("client_id")
  packageId        Int?              @map("package_id")
  isActive         Boolean           @default(true) @map("is_active")
  isDeleted        Boolean           @default(false) @map("is_deleted")
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime?         @map("deleted_at") @db.Timestamptz(6)
  maxParticipants  Int?              @map("max_participants")
  quizzes          QuizAssignment[]
  enrollments      Enrollment[]      @relation("ProgramEnrollments")
  leaderboards     Leaderboard[]
  measureProgress  MeasureProgress[]
  programModules   ProgramModule[]
  author           Admin             @relation("ProgramAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@map("programs")
}

model Module {
  id                   Int               @id @default(autoincrement())
  title                String            @db.VarChar(255)
  description          String?
  prerequisiteModuleId Int?              @map("prerequisite_module_id")
  status               Int?              @db.SmallInt
  isDeleted            Boolean           @default(false) @map("is_deleted")
  deletedAt            DateTime?         @map("deleted_at") @db.Timestamptz(6)
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  measureProgress      MeasureProgress[]
  moduleTopics         ModuleTopic[]
  prerequisiteModule   Module?           @relation("ModulePrerequisite", fields: [prerequisiteModuleId], references: [id])
  dependentModules     Module[]          @relation("ModulePrerequisite")
  programModules       ProgramModule[]

  @@map("modules")
}

model Enrollment {
  id         Int      @id @default(autoincrement())
  learnerId  Int      @map("learner_id")
  programId  Int      @map("program_id")
  enrolledAt DateTime @default(now()) @map("enrolled_at") @db.Timestamptz(6)
  learner    Learner  @relation("LearnerEnrollments", fields: [learnerId], references: [id], onDelete: Cascade)
  program    Program  @relation("ProgramEnrollments", fields: [programId], references: [id], onDelete: Cascade)

  @@unique([learnerId, programId])
  @@map("enrollments")
}

model ProgramModule {
  programId Int
  moduleId  Int
  position  Int
  module    Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@id([programId, moduleId])
  @@unique([programId, position])
  @@map("program_modules")
}

model Topic {
  id                  Int               @id @default(autoincrement())
  title               String            @db.VarChar(255)
  prerequisiteTopicId Int?              @map("prerequisite_topic_id")
  status              Int?              @db.SmallInt
  isDeleted           Boolean           @default(false) @map("is_deleted")
  deletedAt           DateTime?         @map("deleted_at") @db.Timestamptz(6)
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  description         String
  measureProgress     MeasureProgress[]
  moduleTopics        ModuleTopic[]
  topicResources      TopicResource[]
  prerequisiteTopic   Topic?            @relation("TopicPrerequisite", fields: [prerequisiteTopicId], references: [id])
  dependentTopics     Topic[]           @relation("TopicPrerequisite")

  @@map("topics")
}

model ModuleTopic {
  moduleId Int
  topicId  Int
  position Int
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  topic    Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([moduleId, topicId])
  @@unique([moduleId, position])
  @@map("module_topics")
}

model Resource {
  id              Int               @id @default(autoincrement())
  resourceType    ResourceType      @map("resource_type")
  url             String
  title           String?           @db.VarChar(255)
  description     String?
  status          Int?              @db.SmallInt
  isDeleted       Boolean           @default(false) @map("is_deleted")
  deletedAt       DateTime?         @map("deleted_at") @db.Timestamptz(6)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  measureProgress MeasureProgress[]
  resourceViews   ResourceView[]
  topicResources  TopicResource[]

  @@map("resources")
}

model TopicResource {
  topicId    Int
  resourceId Int
  position   Int
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  topic      Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([topicId, resourceId])
  @@unique([topicId, position])
  @@map("topic_resources")
}

model QuestionPool {//questions
  id                 Int                 @id @default(autoincrement())
  authorId           Int                 @map("author_id")
  questionText       String              @map("question_text")
  questionType       QuestionType        @map("question_type")
  points             Int                 @default(1)
  option1            String?             @map("option_1")
  option2            String?             @map("option_2")
  option3            String?             @map("option_3")
  option4            String?             @map("option_4")
  option5            String?             @map("option_5")
  option6            String?             @map("option_6")
  answer             String?
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  author             Admin               @relation("QuestionAuthor", fields: [authorId], references: [id], onDelete: Cascade)      
 
 //relation
  questionPapers     QuestionPaperQuestion[] 
  @@map("questions_pool")
}

model QuizAssignment {
  id              Int             @id @default(autoincrement())
  rules           String
  questionPaperId Int             @map("question_paper_id")//link to questionPaper table
  title           String
  description     String
  programId       Int?            @map("program_id")
  // startAt         DateTime?       @map("start_at") @db.Timestamptz(6)
  // endAt           DateTime?       @map("end_at") @db.Timestamptz(6)
  uniqueLinkToken String          @unique @default(uuid()) @map("unique_link_token") @db.Uuid
  // timeMode        TimeMode        @default(none) @map("time_mode")
  //wrongAnsMode    WrongAnswerMode @default(none) @map("wrong_ans_mode")
  //resultMode      ResultMode      @default(none) @map("result_mode")
  //totalTimeLimit  Int?            @map("total_time_limit")
  //passingScore    Int?            @map("passing_score")
  enabled         Boolean         @default(true)
  isDeleted       Boolean         @default(false) @map("is_deleted")
  deletedAt       DateTime?       @map("deleted_at") @db.Timestamptz(6)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  

  //Relation
  program         Program?        @relation(fields: [programId], references: [id], onDelete: Cascade)
  questionPaper   QuestionPaper   @relation(fields: [questionPaperId], references:[id], onDelete: Cascade)
  quizAttempts    QuizAttempt[]   @relation("AssignmentAttempts") //Learner's attempt. Same quiz assignment can be taken by multiple learners

  @@map("quiz_assignments")
}

model QuestionPaper {
  id                Int               @id @default(autoincrement())
  name              String
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  questions         QuestionPaperQuestion[]
  quizAssignments   QuizAssignment[]  // One paper can be used in many quizzes

  @@map("question_papers")
}

model QuestionPaperQuestion {
  id              Int           @id @default(autoincrement())
  questionId      Int           @map("question_id")
  questionPaperId Int           @map("question_paper_id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  question        QuestionPool  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionPaper   QuestionPaper @relation(fields: [questionPaperId], references: [id], onDelete: Cascade)

  @@unique([questionId, questionPaperId])
  @@map("question_paper_questions")
}

model QuizAttempt {
  id               Int               @id @default(autoincrement())
  assignmentId     Int               @map("assignment_id")
  learnerId        Int               @map("learner_id")
  startedAt        DateTime          @default(now()) @map("started_at") @db.Timestamptz(6)
  submittedAt      DateTime?         @map("submitted_at") @db.Timestamptz(6)
  totalTimeSpent   Int?              @map("total_time_spent")
  score            Decimal?          @db.Decimal(5, 2)
  passed           Boolean?
  status           String            @db.VarChar(20)
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  //relation
  questionAttempts QuestionAttempt[]
  assignment       QuizAssignment    @relation("AssignmentAttempts", fields: [assignmentId], references: [id], onDelete: Cascade)
  learner          Learner           @relation("LearnerAttempts", fields: [learnerId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model QuestionAttempt {
  attemptId    Int          @map("attempt_id")
  questionId   Int          @map("question_id")
  answerText   String?      @map("answer_text")
  isCorrect    Boolean      @map("is_correct")
  timeTakenSec Int?         @map("time_taken_sec")
  attempt      QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@id([attemptId, questionId])
  @@map("question_attempts")
}

model ResourceView {
  learnerId  Int      @map("learner_id")
  resourceId Int      @map("resource_id")
  viewedAt   DateTime @default(now()) @map("viewed_at") @db.Timestamptz(6)
  learner    Learner  @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@id([learnerId, resourceId])
  @@map("resource_views")
}

model MeasureProgress {
  id         Int      @id @default(autoincrement())
  learnerId    Int       @map("learner_id")
  topicId      Int?       @map("topic_id")
  completedAt  DateTime  @default(now()) @map("completed_at") @db.Timestamptz(6)
  status       String    @db.VarChar(20)
  progressType String    @map("progress_type") @db.VarChar(20)
  programId    Int?      @map("program_id")
  moduleId     Int?      @map("module_id")
  quizId       Int?      @map("quiz_id")
  resourceId   Int?      @map("resource_id")
  learner      Learner   @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  module       Module?   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  program      Program?  @relation(fields: [programId], references: [id], onDelete: Cascade)
  resource     Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  topic        Topic?     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  @@map("measure_progress")
}


model Leaderboard {
  programId     Int       @map("program_id")
  learnerId     Int       @map("learner_id")
  totalScore    Decimal   @map("total_score") @db.Decimal(6, 2)
  lastAttemptAt DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  learner       Learner   @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  program       Program   @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@id([programId, learnerId])
  @@map("leaderboard")
}

enum AdminType {
  SystemAdmin
  PartnerAdmin
}

enum ProgramType {
  self_paced
  tutor_paced
  workshop
  webinar
}

enum ResourceType {
  video
  document
  image
  other
}

enum QuestionType {
  mcq_single
  true_false
  fill_blank
  slider
  text
}

enum TimeMode {
  none
  qns
  exam
}

enum WrongAnswerMode {
  none
  retry
  correct_ans
}

enum ResultMode {
  none
  exam_ends
  later
}
